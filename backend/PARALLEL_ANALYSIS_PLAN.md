# План реализации параллельного анализа репозиториев

Этот документ описывает шаги по внедрению механизма пула инстансов репозиториев для поддержки одновременного анализа различных коммитов одного и того же проекта.

## 1. Конфигурация
- [x] Добавить параметр `repository.instances.count` в `application.properties`.
- [x] Установить значение по умолчанию: `6`.
- [x] Добавить конфигурацию в Java-код через `@Value`.

## 2. Модель данных (Persistence)
- [x] Создать сущность `ProjectInstanceEntity`:
    - `Long id`
    - `GitProjectEntity project` (ManyToOne)
    - `String localPath`
    - `boolean isBusy`
    - `LocalDateTime lastUsedAt`
- [x] Обновить `GitProjectEntity`:
    - Добавить `List<ProjectInstanceEntity> instances` (OneToMany, CascadeType.ALL).
- [x] Создать репозиторий `ProjectInstanceRepository` с методами поиска свободных инстансов.

## 3. Расширение GitProjectService (Клонирование и Копирование)
- [x] Модифицировать метод `cloneNewRepository`:
    - После успешного клонирования основного репозитория создавать еще `N-1` копий.
    - **Оптимизация**: Использовать `git clone --local` для создания копий на диске (быстрее и экономит трафик).
- [x] Модифицировать метод `updateProject`:
    - При выполнении `git pull` в основном репозитории, обновлять (pull) или пересоздавать локальные копии.
- [x] Обновить логику `cleanupExpiredProjects`:
    - Убедиться, что `FileManager` удаляет все директории, связанные со всеми инстансами проекта.

## 4. Арбитр инстансов (Instance Arbitrator)
- [x] Создать сервис `ProjectInstanceArbitrator`:
    - Метод `acquireInstance(Long projectId)`:
        - Поиск свободного инстанса в БД.
        - Установка флага `isBusy = true`.
        - Использование пессимистических блокировок или синхронизации для предотвращения race conditions.
    - Метод `releaseInstance(Long instanceId)`:
        - Установка флага `isBusy = false`.
        - Обновление `lastUsedAt`.

## 5. Интеграция с процессом анализа
- [x] Обновить `CodeAnalysisController` (или сервисы, вызываемые им):
    - Перед анализом запрашивать инстанс у арбитра.
    - Передавать путь к конкретному инстансу в `CodeAnalysisService`.
- [x] Обновить `CodeAnalysisService`:
    - Добавить выполнение `git checkout <sha>` в целевой директории перед началом анализа.
    - Обернуть процесс анализа в `try-finally`, чтобы гарантированно вызывать `releaseInstance`.

## 6. Обработка граничных случаев и Race Conditions
- [x] Реализовать ожидание (retry или очередь), если все 6 инстансов заняты.
- [x] Убедиться, что блокировки `repoLocks` в `GitProjectService` корректно работают при массовом создании копий.
- [ ] Добавить метрики для мониторинга использования пула инстансов.

## 7. Тестирование
- [x] Написать модульные тесты для `ProjectInstanceArbitrator`.
- [x] Написать интеграционный тест: запуск 10 параллельных запросов на анализ одного проекта и проверка, что используются разные директории.
